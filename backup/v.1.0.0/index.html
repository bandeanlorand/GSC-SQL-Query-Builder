<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GSC SQL Query Builder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div id="global-tooltip"
    class="fixed z-50 pointer-events-none bg-gray-900 text-xs text-white p-2 rounded shadow-lg max-w-xs hidden">
  </div>
  <header class="bg-color-[#1f2937] px-8 py-4 text-left flex row items-center justify-between flex-row shadow-lg">
    <div class="items-start justify-start flex-col">
      <h1 class="text-3xl font-bold mb-1 text-xl">Google Search Console SQL Query Builder</h1>
      <p class="mb-1 text-sm">Build your SQL queries for Google Search Console data easily.</p>
    </div>
    <div class="flex items-center">
      <p class="text-sm">powered by</p>
      <a href="#" class="max-w-[120px] block">
        <img src="search-analyzer-logo-1024x341.png" alt="" />
      </a>
    </div>
  </header>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-8 max-w-[1440px] mx-auto">
    <div class="space-y-4">


      <div>
        <label for="dateRange">Date Range</label>
        <div id="dateRangeContainer" class="relative w-full  ">
          <div class="relative group focus-within:ring-0 w-full">
            <!-- Subtle glow layer -->
            <div
              class="absolute -inset-1 bg-gradient-to-r from-cyan-500/30 to-blue-500/30 rounded-[10px] blur-sm opacity-0 group-focus-within:opacity-100 transition duration-300 pointer-events-none">
            </div>

            <!-- Input field -->
            <div id="selectedDateRange" tabindex="0" data-toggle="dropdown" data-target="#dateRangeDropdown"
              data-arrow="#dateRangeArrow"
              class="relative bg-gray-800 border border-gray-600 p-2 rounded-[8px] h-[50px] flex items-center justify-between cursor-pointer focus:outline-none">
              <span id="dateRangeLabel">Select date range</span>


              <svg id="dateRangeArrow" class="w-4 h-4 transition-transform duration-300" fill="none"
                stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>
          <div id="dateRangeDropdown" data-open="false"
            class="bg-gray-800 border border-gray-600 p-2 rounded absolute z-10 transition-all mt-[8px]">
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Yesterday">Yesterday</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Last Week">Last Week</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Last month">Last month</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Month to yesterday">Month to
              yesterday</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Last 7 days">Last 7 days</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Last 14 days">Last 14 days
            </div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Last 30 days">Last 30 days
            </div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Year to yesterday">Year to
              yesterday</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Last year">Last year</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" data-range="Custom date range">Custom date
              range</div>
          </div>
        </div>

        <!-- Custom date inputs start -->
        <!-- Hidden by default, shown when "Custom date range" is selected -->
        <div id="customDateInputs" class="hidden mt-2">
          <div class="grid grid-cols-2 gap-4">
            <!-- Start Date -->
            <div>
              <label for="startDate" class="mb-1 block">Start Date</label>
              <div class="relative group w-full">
                <!-- Glow layer -->
                <div
                  class="absolute -inset-1 bg-gradient-to-r from-cyan-500/30 to-blue-500/30 rounded-[10px] blur-sm opacity-0 group-focus-within:opacity-100 transition duration-300 pointer-events-none">
                </div>
                <!-- Input -->
                <input
                  class="relative z-10 bg-gray-800 border border-gray-600 p-2 h-[50px] w-full rounded-[8px] focus:outline-none"
                  type="date" id="startDate" />
              </div>
            </div>

            <!-- End Date -->
            <div>
              <label for="endDate" class="mb-1 block">End Date</label>
              <div class="relative group w-full">
                <!-- Glow layer -->
                <div
                  class="absolute -inset-1 bg-gradient-to-r from-cyan-500/30 to-blue-500/30 rounded-[10px] blur-sm opacity-0 group-focus-within:opacity-100 transition duration-300 pointer-events-none">
                </div>
                <!-- Input -->
                <input
                  class="relative z-10 bg-gray-800 border border-gray-600 p-2 h-[50px] w-full rounded-[8px] focus:outline-none"
                  type="date" id="endDate" />
              </div>
            </div>
          </div>
        </div>


        <!-- Custom date inputs end -->


        <!-- Metrics starts here -->
        <div class="flex items-center justify-between">
          <label for="metrics">Metrics</label>
          <button id="clearMetricsBtn"
            class="text-sm text-red-100 hover:underline flex items-center space-x-1 w-auto border-none hidden"
            onclick="clearAllMetrics()">
            <i class="fa-regular fa-circle-xmark"></i>
            <span>Clear all</span>
          </button>
        </div>
        <div id="metricsContainer" class="relative w-full group focus-within:ring-0">
          <!-- Subtle glowing border -->
          <div
            class="absolute -inset-1 bg-gradient-to-r from-cyan-500/30 to-blue-500/30 rounded-lg blur-sm opacity-0 group-focus-within:opacity-100 transition duration-300 pointer-events-none">
          </div>

          <!-- Selected metrics box -->
          <div id="selectedMetrics" tabindex="0"
            class="relative bg-gray-800 border border-gray-600 p-2 rounded-[8px] h-[50px] flex items-center justify-between cursor-pointer focus:outline-none">
            <div id="metricsTagsContainer" class="flex flex-wrap gap-2 items-center overflow-auto">
              <span id="metricsPlaceholder" class="text-gray-400">Select metrics</span>
            </div>
            <svg id="metricsArrow" class="w-4 h-4 transition-transform duration-300 ml-2 flex-shrink-0" fill="none"
              stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <!-- Dropdown items -->
          <div id="metricsDropdown" data-open="false"
            class="bg-gray-800 border border-gray-600 p-2 rounded absolute z-10 transition-all mt-[8px]">
            <div class="cursor-pointer p-1 hover:bg-gray-700" onclick="selectMetric('Impressions')">Impressions</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" onclick="selectMetric('Clicks')">Clicks</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" onclick="selectMetric('CTR')">CTR</div>
            <div class="cursor-pointer p-1 hover:bg-gray-700" onclick="selectMetric('Position')">Position</div>
          </div>
        </div>

        <!-- Metrics ends here -->

        <!-- Dimensions starts here -->
        <div class="flex items-center justify-between">
          <label for="dimensions">Dimensions</label>
          <button id="clearDimensionsBtn"
            class="text-sm text-red-100 hover:underline flex items-center space-x-1 w-auto border-none hidden"
            onclick="clearAllDimensions()">
            <i class="fa-regular fa-circle-xmark"></i>
            <span>Clear all</span>
          </button>
        </div>
        <div id="dimensionsContainer" class="relative w-full group focus-within:ring-0">
          <!-- Glow when focused -->
          <div
            class="absolute -inset-1 bg-gradient-to-r from-cyan-500/30 to-blue-500/30 rounded-lg blur-sm opacity-0 group-focus-within:opacity-100 transition duration-300 pointer-events-none">
          </div>

          <!-- Selected Dimensions -->
          <div id="selectedDimensions" tabindex="0"
            class="relative bg-gray-800 border border-gray-600 p-2 rounded-[8px] min-h-[50px] flex items-center justify-between cursor-pointer focus:outline-none">
            <div id="dimensionsTagsContainer" class="flex flex-wrap gap-2 items-center overflow-auto"><span
                id="dimensionsPlaceholder" class="text-gray-400">Select dimensions</span></div>
            <svg id="dimensionsArrow" class="w-4 h-4 transition-transform duration-300 ml-2 flex-shrink-0" fill="none"
              stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <!-- Dimensions dropdown -->
          <div id="dimensionsDropdown"
            class="bg-gray-800 border border-gray-600 p-2 rounded absolute z-10 transition-all max-h-[400px] overflow-y-auto w-full mt-[8px]">
          </div>


        </div>

        <!-- Dimensions ends here -->

        <!-- Filters section starts here -->
        <!-- Filters Header (inside gray box) -->
        <div class="w-full max-w-4xl mx-auto mt-4">
          <div
            class="bg-[#185e70] hover:bg-gray-800 border border-gray-700 rounded-t-lg p-4 text-white flex justify-between items-center cursor-pointer transition transition-all"
            onclick="toggleFilters()">
            <span class="font-bold">Filters</span>
            <svg id="filterArrow" class="w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor"
              stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
          </div>

          <!-- Filters Form Section (outside the gray box) -->
          <!-- filter input and dropdown row starts here -->
          <div id="filterSection" class="hidden bg-transparent px-0 py-4 space-y-2">
            <div id="filterRows" class="space-y-2">
              <!--Filter Row gets injected here -->
            </div>
            <!-- Add/Remove Buttons -->
            <div class="flex gap-2 mt-2">
              <button onclick="addFilterRow()"
                class="w-6 h-6 flex items-center justify-center bg-teal-500 hover:bg-teal-600 text-white rounded-full text-sm font-bold">
                +
              </button>
              <button onclick="removeFilterRow()"
                class="w-6 h-6 flex items-center justify-center bg-teal-500 hover:bg-teal-600 text-white rounded-full text-sm font-bold">
                −
              </button>
            </div>
          </div>
          <!-- Filters section ends here -->
        </div>



        <button type="submit" onclick="generateSQL()"
          class="block w-auto mt-[24px]  m-auto bg-blue-800 text-white border-none px-10 py-2 text-center rounded-[8px] text-[1.25rem] leading-[2rem] ">Generate
          SQL</button>
      </div>
    </div>


    <div>

      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-semibold">Generated SQL</h2>
        <button onclick="copySQL()" onclick="copyToTheClipboard(document.getElementById('sqlOutput').textContent)"
          class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded w-auto">
          Copy SQL
        </button>
      </div>
      <pre id="sqlOutput" class="overflow-auto rounded bg-gray-900 p-4 text-sm whitespace-pre-wrap"></pre>
      <pre id="sqlOutputFormated" class="overflow-auto rounded bg-gray-900 p-4 text-sm whitespace-pre-wrap mt-2 h-1 opacity-0"></pre>

    </div>
  </div>

  <script>
    // Function to toggle the visibility of the filter section
    // and rotate the arrow icon  
    function toggleFilters() {
      const section = document.getElementById('filterSection');
      const arrow = document.getElementById('filterArrow');
      section.classList.toggle('hidden');
      arrow.classList.toggle('rotate-180');
    }

    function toggleCustomDateInputs() {
      // const dateRange = document.getElementById('dateRange').value;
      const customInputs = document.getElementById('customDateInputs');
      if (dateRange === 'Custom date range') {
        customInputs.classList.remove('hidden');
      } else {
        customInputs.classList.add('hidden');
      }
    }

    function getDateRangeClause() {

      const range = selectedDateRange;

      switch (range) {
        case 'Yesterday':
          return 'DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)';
        case 'Last Week':
          return 'DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)';
        case 'Last month':
          return 'DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)';
        case 'Month to yesterday':
          return 'DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY), MONTH) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)';
        case 'Last 7 days':
          return 'DATE_SUB(CURRENT_DATE(), INTERVAL 6 DAY) AND CURRENT_DATE()';
        case 'Last 14 days':
          return 'DATE_SUB(CURRENT_DATE(), INTERVAL 13 DAY) AND CURRENT_DATE()';
        case 'Last 30 days':
          return 'DATE_SUB(CURRENT_DATE(), INTERVAL 29 DAY) AND CURRENT_DATE()';
        case 'Year to yesterday':
          return 'DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY), YEAR) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)';
        case 'Last year':
          return 'DATE_SUB(DATE_TRUNC(CURRENT_DATE(), YEAR), INTERVAL 1 YEAR) AND DATE_SUB(DATE_TRUNC(CURRENT_DATE(), YEAR), INTERVAL 1 DAY)';
        case 'Custom date range':
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;
          if (startDate && endDate) {
            return `DATE('${startDate}') AND DATE('${endDate}')`;
          } else {
            return 'DATE1 AND DATE2 -- replace with actual dates';
          }
        default:
          return '... AND ...';
      }
    }

   
let plainSQL = "";

function generateSQL() {
  const dateClause = getDateRangeClause();
  const metrics = Array.from(selectedMetrics);
  const dimensions = Array.from(selectedDimensions);

  const selectLines = [];
  const plainSelectLines = [];

  dimensions.forEach(dim => {
    selectLines.push(`<span class="sql-column">${dim}</span>`);
    plainSelectLines.push(dim);
  });

  if (metrics.includes('Clicks')) {
    selectLines.push(`<span class="sql-function">SUM(Clicks)</span> AS <span class="sql-alias">clicks</span>`);
    plainSelectLines.push(`SUM(Clicks) AS clicks`);
  }
  if (metrics.includes('Impressions')) {
    selectLines.push(`<span class="sql-function">SUM(Impressions)</span> AS <span class="sql-alias">impressions</span>`);
    plainSelectLines.push(`SUM(Impressions) AS impressions`);
  }
  if (metrics.includes('CTR')) {
    selectLines.push(`<span class="sql-expression">SUM(Clicks) / SUM(Impressions)</span> AS <span class="sql-alias">ctr</span>`);
    plainSelectLines.push(`SUM(Clicks) / SUM(Impressions) AS ctr`);
  }
  if (metrics.includes('Position')) {
    selectLines.push(`((<span class="sql-function">SUM(sum_position)</span> / <span class="sql-function">SUM(Impressions)</span>) + 1.0) AS <span class="sql-alias">avg_position</span>`);
    plainSelectLines.push(`((SUM(sum_position) / SUM(Impressions)) + 1.0) AS avg_position`);
  }

  const selectClause = `<span class="sql-keyword">SELECT</span><br>${selectLines.join(',<br>')}`;
  const plainSelectClause = `SELECT\n${plainSelectLines.join(',\n')}`;

  const fromTable = dimensions.includes('URL')
    ? '`searchconsole.searchdata_url_impression`'
    : '`searchconsole.searchdata_site_impression`';

  const fromClause = `<br><span class="sql-keyword">FROM</span><br>  <span class="sql-table">${fromTable}</span>`;
  const plainFromClause = `FROM\n  ${fromTable}`;

  const filterWrappers = document.querySelectorAll('#filterRows > div');
  const filterConditions = [];
  const plainFilterConditions = [];

  filterWrappers.forEach((wrapper) => {
    const selects = wrapper.querySelectorAll('select');
    const input = wrapper.querySelector('input[type="text"]');
    const field = selects[0]?.value;
    const operator = selects[1]?.value;
    const value = input?.value;

    if (!field || !operator || (operator.indexOf('NULL') === -1 && !value)) return;

    let sqlOp;
    if (operator === 'EQUALS') sqlOp = '=';
    else if (operator === 'NOT EQUALS') sqlOp = '!=';
    else if (operator === 'CONTAINS') sqlOp = 'LIKE';
    else if (operator === 'NOT CONTAINS') sqlOp = 'NOT LIKE';
    else if (operator === 'GREATER THAN') sqlOp = '>';
    else if (operator === 'LESS THAN') sqlOp = '<';
    else if (operator === 'IS NULL') {
      filterConditions.push(`<span class="sql-keyword">AND</span> ${field} <span class="sql-keyword">IS NULL</span>`);
      plainFilterConditions.push(`AND ${field} IS NULL`);
      return;
    } else if (operator === 'IS NOT NULL') {
      filterConditions.push(`<span class="sql-keyword">AND</span> ${field} <span class="sql-keyword">IS NOT NULL</span>`);
      plainFilterConditions.push(`AND ${field} IS NOT NULL`);
      return;
    }

    let condition = `${field} ${sqlOp} '${sqlOp.includes('LIKE') ? `%${value}%` : value}'`;
    filterConditions.push(`<span class="sql-keyword">AND</span> ${condition}`);
    plainFilterConditions.push(`AND ${condition}`);
  });

  const whereClause = `<br><span class="sql-keyword">WHERE</span><br>  <span class="sql-column">data_date</span> <span class="sql-keyword">BETWEEN</span> ${dateClause}` + (filterConditions.length ? `<br>  ${filterConditions.join('<br>  ')}` : '');
  const plainWhereClause = `WHERE\n  data_date BETWEEN ${dateClause}` + (plainFilterConditions.length ? `\n  ${plainFilterConditions.join('\n  ')}` : '');

  const groupByClause = dimensions.length
    ? `<br><span class="sql-keyword">GROUP BY</span><br>  ${dimensions.map(d => `<span class="sql-column">${d}</span>`).join(', ')}`
    : '';
  const plainGroupByClause = dimensions.length
    ? `GROUP BY\n  ${dimensions.join(', ')}`
    : '';

  const sql = `${selectClause}${fromClause}${whereClause}${groupByClause}`;
  plainSQL = `${plainSelectClause}\n${plainFromClause}\n${plainWhereClause}${plainGroupByClause ? `\n${plainGroupByClause}` : ''}`;

  document.getElementById('sqlOutput').innerHTML = sql;
  document.getElementById('sqlOutputFormated').textContent = plainSQL;
}

function copySQL() {
  navigator.clipboard.writeText(plainSQL).then(() => {
    document.body.classList.add('show-copied');
    setTimeout(() => document.body.classList.remove('show-copied'), 3000);
  }).catch(err => console.error('Copy failed', err));
}

function getDateRangeClause() {
  const range = selectedDateRange;
  switch (range) {
    case 'Yesterday':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last Week':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last month':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Month to yesterday':
      return `DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY), MONTH) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last 7 days':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 6 DAY) AND CURRENT_DATE()`;
    case 'Last 14 days':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 13 DAY) AND CURRENT_DATE()`;
    case 'Last 30 days':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 29 DAY) AND CURRENT_DATE()`;
    case 'Year to yesterday':
      return `DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY), YEAR) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last year':
      return `DATE_SUB(DATE_TRUNC(CURRENT_DATE(), YEAR), INTERVAL 1 YEAR) AND DATE_SUB(DATE_TRUNC(CURRENT_DATE(), YEAR), INTERVAL 1 DAY)`;
    case 'Custom date range':
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate && endDate) {
        return `DATE('${startDate}') AND DATE('${endDate}')`;
      } else {
        return 'DATE1 AND DATE2 -- replace with actual dates';
      }
    default:
      return '... AND ...';
  }
}

function getDateRangeClause() {
  const range = selectedDateRange;
  switch (range) {
    case 'Yesterday':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last Week':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last month':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Month to yesterday':
      return `DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY), MONTH) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last 7 days':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 6 DAY) AND CURRENT_DATE()`;
    case 'Last 14 days':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 13 DAY) AND CURRENT_DATE()`;
    case 'Last 30 days':
      return `DATE_SUB(CURRENT_DATE(), INTERVAL 29 DAY) AND CURRENT_DATE()`;
    case 'Year to yesterday':
      return `DATE_TRUNC(DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY), YEAR) AND DATE_SUB(CURRENT_DATE(), INTERVAL 1 DAY)`;
    case 'Last year':
      return `DATE_SUB(DATE_TRUNC(CURRENT_DATE(), YEAR), INTERVAL 1 YEAR) AND DATE_SUB(DATE_TRUNC(CURRENT_DATE(), YEAR), INTERVAL 1 DAY)`;
    case 'Custom date range':
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      if (startDate && endDate) {
        return `DATE('${startDate}') AND DATE('${endDate}')`;
      } else {
        return 'DATE1 AND DATE2 -- replace with actual dates';
      }
    default:
      return '... AND ...';
  }
}


    /*  generateSQL function ends here */



    /* metrics multiselect script - starts here */
    const selectedMetrics = new Set();
    let isDropdownOpen = false;

    const selectedDimensions = new Set();
    // let isDimensionsDropdownOpen = false;

    let selectedDateRange = '';
    let isDateRangeDropdownOpen = false;

    document.getElementById("selectedDateRange").addEventListener("click", (event) => {
      event.stopPropagation();

      const dropdown = document.getElementById("dateRangeDropdown");
      const arrow = document.getElementById("dateRangeArrow");
      const isOpen = dropdown.getAttribute("data-open") === "true";

      toggleDropdown(dropdown, arrow, !isOpen);
    });
    window.selectDateRange = selectDateRange;

    function selectDateRange(range) {
      selectedDateRange = range;
      document.getElementById("dateRangeLabel").textContent = range;
      closeDropdown(document.getElementById("dateRangeDropdown"));
      isDateRangeDropdownOpen = false;
      toggleCustomDateInputs(range); // Show/hide custom fields
    }
    // Bind selection for all date range items
    document.querySelectorAll('#dateRangeDropdown [data-range]').forEach(item => {
      item.addEventListener('click', () => {
        const range = item.getAttribute('data-range');
        selectDateRange(range);
      });
    });

    function toggleCustomDateInputs(range) {
      const customInputs = document.getElementById('customDateInputs');
      if (range === 'Custom date range') {
        customInputs.classList.remove('hidden');
      } else {
        customInputs.classList.add('hidden');
      }
    }



    // Populate dimensions dropdown
    const dimensionEntries = [
      ["Query", "The user query. When is_anonymized_query is true, this will be a zero-length string."],
      ["URL", "The fully-qualified URL where the user eventually lands when they click the search result or Discover story."],
      ["Country", "Country from where the query was made, in ISO-3166-1-Alpha-3 format (for example, “USA”)."],
      ["Search Type", "The type of search (web, image, video, or news)."],
      ["Device", "The device type (desktop, tablet, or mobile)."],
      ["Site URL", "URL of the property. For domain-level properties, this will be sc-domain:property-name. For URL-prefix properties, it will be the full URL of the property definition."],
      ["Date", "The day on which the data in this row was generated (Pacific Time)."],
      ["Month", "The month (YYYY-MM) of the data in this row."],
      ["Year", "The year (YYYY) of the data in this row."],
      ["Is Anonymized Query", "Rare queries (called anonymized queries) are marked with this bool. The query field will be null when it’s true to protect the privacy of users making the query."],
      ["Is Anonymized Discover", "Whether the data row is under the Discover anonymization threshold. When under the threshold, some other fields (like URL and country) will be missing to protect user privacy."],
      ["Is AMP Top Stories", "Whether the URL is an AMP Top Story."],
      ["Is AMP Blue Link", "Whether the URL is an AMP Blue Link."],
      ["Is Job Listing", "Whether the URL is a job listing."],
      ["Is Job Details", "Whether the URL is a job details page."],
      ["Is TPF QA", "Whether the URL is a top places for a query."],
      ["Is TPF FAQ", "Whether the URL is a top places faq."],
      ["Is TPF HowTo", "Whether the URL is a top places how-to."],
      ["Is Weblite", "Whether the URL is a weblite."],
      ["Is Action", "Whether the URL is an action."],
      ["Is Events Listing", "Whether the URL is an events listing."],
      ["Is Events Details", "Whether the URL is an events details page."],
      ["Is Search Appearance Android App", "Whether the URL is a search appearance android app."],
      ["Is AMP Story", "Whether the URL is an AMP story."],
      ["Is AMP Image Result", "Whether the URL is an AMP image result."],
      ["Is Video", "Whether the URL is a video."],
      ["Is Organc Shopping", "Whether the URL is an organic shopping result."],
      ["Is Review Snippet", "Whether the URL is a review snippet."],
      ["Is Special Announcement", "Whether the URL is a special announcement."],
      ["Is Recipe Feature", "Whether the URL is a recipe feature."],
      ["Is Recipe Rich Snippet", "Whether the URL is a recipe rich snippet."],
      ["Is Subscribed Content", "Whether the URL is subscribed content."],
      ["Is Page Experience", "Whether the URL is a page experience."],
      ["Is Practice Problems", "Whether the URL is a practice problem."],
      ["Is Math Solvers", "Whether the URL is a math solver."],
      ["Is Translated Result", "Whether the URL is a translated result."],
      ["Is Product Snippets", "Whether the URL is a product snippet."],
      ["Is Merchant Listings", "Whether the URL is a merchant listing."]
    ];

    const dimensionsDropdown = document.getElementById("dimensionsDropdown");
    dimensionsDropdown.innerHTML = '<div id="dimensionsScrollArea" class="max-h-[400px] overflow-y-auto pr-2"></div>';
    const scrollArea = document.getElementById("dimensionsScrollArea");


    const tooltipBox = document.getElementById("global-tooltip");

    dimensionEntries.forEach(([name, tooltip]) => {
      const item = document.createElement("div");
      item.className = "relative cursor-pointer p-1 hover:bg-gray-700 flex items-center justify-between";
      item.setAttribute("onclick", `selectDimension('${name}')`);

      const span = document.createElement("span");
      span.textContent = name;

      // Icon setup
      const icon = document.createElement("i");
      icon.className = "far fa-question-circle text-gray-400";
      icon.style.cursor = "pointer";

      // Tooltip logic
      icon.addEventListener("mouseenter", (e) => {
        tooltipBox.textContent = tooltip;
        tooltipBox.classList.remove("hidden");

        const rect = e.target.getBoundingClientRect();
        tooltipBox.style.top = `${rect.top + window.scrollY}px`;
        tooltipBox.style.left = `${rect.right + 8 + window.scrollX}px`;
      });

      icon.addEventListener("mouseleave", () => {
        tooltipBox.classList.add("hidden");
      });

      item.appendChild(span);
      item.appendChild(icon);
      dimensionsDropdown.appendChild(item);
    });


    // dimensions dropdown items end


    function selectDimension(dimension) {
      if (selectedDimensions.has(dimension)) return;
      selectedDimensions.add(dimension);

      // Hide the item in dropdown
      const dropdownItems = document.querySelectorAll("#dimensionsDropdown > div");
      dropdownItems.forEach(item => {
        const label = item.querySelector("span");
        if (label && label.textContent === dimension) {
          item.style.display = "none";
        }
      });

      // Hide placeholder
      const placeholder = document.getElementById("dimensionsPlaceholder");
      if (placeholder) placeholder.classList.add("hidden");

      // Create and append tag
      const tag = document.createElement("div");
      tag.className = "tag-metric bg-[#145da0] shadow-md text-white px-2 py-[2px] h-[28px] rounded-[8px] flex items-center space-x-2 text-sm whitespace-nowrap";
      tag.id = `tag-dimension-${dimension}`;
      tag.innerHTML = `${dimension} <button onclick="removeDimension('${dimension}')" class="ml-2 mt-[-2px] leading-none text-[1.2rem] text-white font-bold outline-none border-none p-[2px] font-extralight">&times;</button>`;

      document.getElementById("dimensionsTagsContainer").appendChild(tag);

      closeDropdown(document.getElementById("dimensionsDropdown"));
      updateClearDimensionsButton();
    }




    function removeDimension(dimension) {
      selectedDimensions.delete(dimension);

      // Remove tag
      const tag = document.getElementById(`tag-dimension-${dimension}`);
      if (tag) tag.remove();

      // Show item in dropdown again
      const dropdownItems = document.querySelectorAll("#dimensionsDropdown > div");
      dropdownItems.forEach(item => {
        const label = item.querySelector("span");
        if (label && label.textContent === dimension) {
          item.style.display = "flex";
        }
      });

      // Show placeholder if empty
      if (selectedDimensions.size === 0) {
        const placeholder = document.getElementById("dimensionsPlaceholder");
        if (placeholder) placeholder.classList.remove("hidden");
      }

      updateClearDimensionsButton();
    }


    function updateClearMetricsButton() {
      const clearBtn = document.getElementById("clearMetricsBtn");
      if (selectedMetrics.size >= 2) {
        clearBtn.classList.remove("hidden");
      } else {
        clearBtn.classList.add("hidden");
      }
    }

    function updateMetricsArrowState() {
      const visibleItems = Array.from(document.querySelectorAll("#metricsDropdown > div"))
        .filter(item => item.style.display !== "none");

      const arrow = document.getElementById("metricsArrow");
      if (visibleItems.length === 0) {
        arrow.classList.add("text-gray-500", "cursor-not-allowed");
      } else {
        arrow.classList.remove("text-gray-500", "cursor-not-allowed");
      }
    }


    function selectMetric(metric) {
      if (selectedMetrics.has(metric)) return;

      const container = document.getElementById("metricsTagsContainer");
      const placeholder = document.getElementById("metricsPlaceholder");

      if (!container || !placeholder) {
        console.error("selectMetric error: container or placeholder is missing");
        return;
      }

      selectedMetrics.add(metric);

      // Hide the metric in the dropdown
      document.querySelectorAll("#metricsDropdown > div").forEach(item => {
        if (item.textContent === metric) item.style.display = "none";
      });

      // Create metric tag
      const tag = document.createElement("div");
      tag.className = "tag-metric bg-[#145da0] shadow-md text-white px-2 py-[2px] h-[28px] rounded-[8px] flex items-center space-x-2 text-sm whitespace-nowrap";
      tag.id = `tag-${metric}`;

      const label = document.createElement("span");
      label.textContent = metric;

      const closeBtn = document.createElement("button");
      closeBtn.className = "ml-2 mt-[-2px] leading-none text-[1.2rem] text-white font-bold outline-none border-none p-[2px] font-extralight";
      closeBtn.textContent = "×";

      // Prevent bubbling up to selectedMetrics
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        removeMetric(metric);
      });

      tag.appendChild(label);
      tag.appendChild(closeBtn);
      container.appendChild(tag);

      // Hide placeholder
      placeholder.classList.add("hidden");

      // Close dropdown and rotate arrow back
      toggleDropdown(metricsDropdown, metricsArrow, false);
      isDropdownOpen = false;

      // Hide dropdown if all metrics are selected
      const visibleItems = Array.from(document.querySelectorAll("#metricsDropdown > div"))
        .filter(item => item.style.display !== "none");
      if (visibleItems.length === 0) {
        metricsDropdown.classList.add("hidden");
      }

      updateClearMetricsButton();
      updateMetricsArrowState();
    }




    // Function to update the "Clear all" button visibility
    function removeMetric(metric) {
      selectedMetrics.delete(metric);
      document.getElementById(`tag-${metric}`)?.remove();

      document.querySelectorAll("#metricsDropdown > div").forEach(item => {
        if (item.textContent === metric) item.style.display = "block";
      });

      if (selectedMetrics.size === 0) {
        metricsPlaceholder.classList.remove("hidden");
      }

      // Allow dropdown to be reopened after removal
      isDropdownOpen = false;
      toggleDropdown(metricsDropdown, metricsArrow, false);
      updateClearMetricsButton();
      updateMetricsArrowState();
    }

    function clearAllMetrics() {
      const tagContainer = document.getElementById("metricsTagsContainer");
      const placeholder = document.getElementById("metricsPlaceholder");
      const arrow = document.getElementById("metricsArrow");

      if (!tagContainer || !placeholder) {
        console.error("clearAllMetrics error: tags container or placeholder is missing");
        return;
      }

      tagContainer.querySelectorAll("div").forEach(tag => tag.remove());
      selectedMetrics.clear();
      placeholder.classList.remove("hidden");

      document.querySelectorAll("#metricsDropdown > div").forEach(item => {
        item.style.display = "block";
      });

      updateClearMetricsButton();
      updateMetricsArrowState();

      isDropdownOpen = false;
      toggleDropdown(metricsDropdown, arrow, false);
    }





    const selectedMetricsEl = document.getElementById("selectedMetrics");
    const metricsDropdown = document.getElementById("metricsDropdown");

    // let isDropdownOpen = false;

    selectedMetricsEl.addEventListener("click", (event) => {
      // Prevent dropdown toggle if clicking a tag (e.g., close button)
      if (event.target.closest(".tag-metric")) return;

      const arrow = document.getElementById("metricsArrow");

      // Block — if arrow is disabled, stop everything
      if (arrow.classList.contains("cursor-not-allowed")) {
        return;
      }

      const visibleItems = Array.from(metricsDropdown.querySelectorAll("div"))
        .filter(item => item.style.display !== "none");

      const isOpen = metricsDropdown.getAttribute("data-open") === "true";

      if (visibleItems.length === 0) {
        closeDropdown(metricsDropdown);
        arrow.classList.remove("rotate-180");
        return;
      }

      toggleDropdown(metricsDropdown, arrow, !isOpen);
      isDropdownOpen = !isOpen;
    });








    /* metrics multiselect script - ends here */

    // Close metricsDropdown when clicking outside
    document.addEventListener("click", function (event) {
      const dropdowns = document.querySelectorAll('[data-open="true"]');
      const arrows = document.querySelectorAll('svg.rotate-180');

      dropdowns.forEach(d => {
        if (!d.contains(event.target)) {
          d.setAttribute("data-open", "false");
          closeDropdown(d);
        }
      });

      arrows.forEach(a => {
        if (!a.contains(event.target)) {
          a.classList.remove("rotate-180");
        }
      });
    });


    function closeDropdown(dropdown) {
      dropdown.style.height = "0px";

      setTimeout(() => {
        dropdown.style.width = "0px";
        dropdown.style.opacity = "0";
      }, 300);

      setTimeout(() => {
        dropdown.classList.remove("block");
        dropdown.classList.add("hidden");
        dropdown.setAttribute("data-open", "false");
      }, 600);
    }

    function openDropdown(dropdown) {
      dropdown.classList.remove("hidden");
      dropdown.classList.add("block");

      dropdown.style.height = "0px";
      dropdown.style.width = "0px";
      dropdown.style.opacity = "0";

      requestAnimationFrame(() => {
        dropdown.style.width = "100%";
        dropdown.style.opacity = "1";

        setTimeout(() => {
          dropdown.style.height = dropdown.scrollHeight + "px";
          dropdown.setAttribute("data-open", "true");
        }, 100);
      });
    }


    function toggleDropdown(dropdown, arrow, open) {
      const allDropdowns = document.querySelectorAll('[data-open="true"]');
      const allArrows = document.querySelectorAll('svg.rotate-180');

      // Close any other open dropdowns and reset arrows
      allDropdowns.forEach(d => {
        if (d !== dropdown) closeDropdown(d);
      });
      allArrows.forEach(a => {
        if (a !== arrow) a.classList.remove("rotate-180");
      });

      const visibleItems = Array.from(dropdown.querySelectorAll("div"))
        .filter(item => item.style.display !== "none");

      const arrowDisabled = arrow?.classList.contains("cursor-not-allowed");

      if (open && visibleItems.length === 0) {
        closeDropdown(dropdown);
        arrow?.classList.remove("rotate-180");
        return;
      }

      if (open) {
        openDropdown(dropdown);
        if (!arrowDisabled) arrow?.classList.add("rotate-180");
      } else {
        closeDropdown(dropdown);
        arrow?.classList.remove("rotate-180");
      }
    }






    // toogle filters slide down starts here
    function toggleFilters() {
      const section = document.getElementById('filterSection');
      const arrow = document.getElementById('filterArrow');
      section.classList.toggle('hidden');
      arrow.classList.toggle('rotate-180');
    }
    // toogle filters slide down ends here


    //
    document.querySelectorAll('[data-toggle="dropdown"]').forEach(toggle => {
      toggle.addEventListener('click', function (e) {
        e.stopPropagation();

        const targetSelector = this.getAttribute('data-target');
        const arrowSelector = this.getAttribute('data-arrow');
        const dropdown = document.querySelector(targetSelector);
        const arrow = document.querySelector(arrowSelector);
        const isOpen = dropdown.getAttribute('data-open') === 'true';

        // Close all dropdowns
        document.querySelectorAll('[data-toggle="dropdown"]').forEach(el => {
          const d = document.querySelector(el.getAttribute('data-target'));
          const a = document.querySelector(el.getAttribute('data-arrow'));
          if (d) {
            d.style.height = "0px";
            d.style.width = "0px";
            d.style.opacity = "0";
            d.setAttribute('data-open', 'false');
          }
          if (a) a.classList.remove('rotate-180');
        });

        // Open current if it was closed
        if (!isOpen) {
          dropdown.style.height = dropdown.scrollHeight + "px";
          dropdown.style.width = "100%";
          dropdown.style.opacity = "1";
          dropdown.setAttribute('data-open', 'true');
          arrow?.classList.add('rotate-180');
        }
      });
    });



    let isDimensionsDropdownOpen = false;


    const selectedDimensionsEl = document.getElementById("selectedDimensions");
    const dimensionsArrow = document.getElementById("dimensionsArrow");

    selectedDimensionsEl.addEventListener("click", (event) => {
      if (event.target.closest(".tag-metric")) return;

      const isOpen = dimensionsDropdown.getAttribute("data-open") === "true";

      // Close other dropdowns
      document.querySelectorAll('[data-open="true"]').forEach(d => {
        if (d !== dimensionsDropdown) closeDropdown(d);
      });
      document.querySelectorAll('svg.rotate-180').forEach(a => {
        if (a !== dimensionsArrow) a.classList.remove("rotate-180");
      });

      toggleDropdown(dimensionsDropdown, dimensionsArrow, !isOpen);
      isDimensionsDropdownOpen = !isOpen;
    });

    function updateClearDimensionsButton() {
      const btn = document.getElementById("clearDimensionsBtn");
      if (selectedDimensions.size >= 2) {
        btn.classList.remove("hidden");
      } else {
        btn.classList.add("hidden");
      }
    }

    function clearAllDimensions() {
      selectedDimensions.clear();
      document.getElementById("dimensionsTagsContainer").innerHTML = "";

      // Show placeholder again
      const placeholder = document.getElementById("dimensionsPlaceholder");
      if (placeholder) placeholder.classList.remove("hidden");

      document.querySelectorAll("#dimensionsDropdown > div").forEach(item => {
        item.style.display = "flex";
      });

      updateClearDimensionsButton();
      toggleDropdown(dimensionsDropdown, dimensionsArrow, false);
    }

    //filter functionality starts here

    /* add filter row script starts here */

    const fieldOptions = [
      "Query", "URL", "Country", "Search Type", "Device", "Site URL", "Date", "Month", "Year",
      "Is Anonymized Query", "Is Anonymized Discover", "Is AMP Top Stories", "Is AMP Blue Link", "Is Job Listing",
      "Is Job Details", "Is TPF QA", "Is TPF FAQ", "Is TPF HowTo", "Is Weblite", "Is Action", "Is Events Listing",
      "Is Events Details", "Is Search Appearance Android App", "Is AMP Story", "Is AMP Image Result", "Is Video",
      "Is Organc Shopping", "Is Review Snippet", "Is Special Announcement", "Is Recipe Feature", "Is Recipe Rich Snippet",
      "Is Subscribed Content", "Is Page Experience", "Is Practice Problems", "Is Math Solvers", "Is Translated Result",
      "Is Product Snippets", "Is Merchant Listings", "Impressions"
    ];

    const operatorOptions = [
      "EQUALS", "NOT EQUALS", "CONTAINS", "NOT CONTAINS", "GREATER THAN",
      "LESS THAN", "IS NULL", "IS NOT NULL"
    ];


    function addFilterRow() {
      const container = document.getElementById('filterRows');
      const isFirst = container.children.length === 0;

      const wrapper = document.createElement('div');
      wrapper.className = "space-y-2 w-full transition-all duration-500 ease-in-out overflow-hidden opacity-100 max-h-[200px]";

      // Top row (only for non-first filters): radio buttons + remove button
      if (!isFirst) {
        const topRow = document.createElement('div');
        topRow.className = "flex justify-between items-center";

        const radioGroup = document.createElement('div');
        radioGroup.className = "flex items-center gap-4 text-sm text-white";

        radioGroup.innerHTML = `
      <label class="inline-flex items-center gap-1">
        <input type="radio" name="logicGroup-${container.children.length}" value="AND" class="text-blue-500 focus:ring-0" checked />
        AND
      </label>
      <label class="inline-flex items-center gap-1">
        <input type="radio" name="logicGroup-${container.children.length}" value="OR" class="text-blue-500 focus:ring-0" />
        OR
      </label>
    `;

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = "&times;";
        removeBtn.className = "text-white text-lg font-bold px-3 hover:text-red-500 flex w-auto";
        removeBtn.onclick = () => {
          wrapper.style.opacity = '0';
          wrapper.style.maxHeight = '0px';
          wrapper.style.padding = '0';
          wrapper.style.margin = '0';
          setTimeout(() => wrapper.remove(), 500);
        };

        topRow.appendChild(radioGroup);
        topRow.appendChild(removeBtn);
        wrapper.appendChild(topRow);
      }

      // Bottom row: field, operator, input
      const bottomRow = document.createElement('div');
      bottomRow.className = "flex flex-nowrap items-center gap-2 overflow-x-auto";

      const fieldSelect = document.createElement('select');
      fieldSelect.className = "h-10 px-3 border border-gray-700 rounded-[8px] bg-gray-800 text-white w-[140px]";
      fieldSelect.innerHTML = `<option value="" disabled selected>Select Field</option>` +
        fieldOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');

      const operatorSelect = document.createElement('select');
      operatorSelect.className = "h-10 px-3 border border-gray-700 rounded-[8px] bg-gray-800 text-white w-[140px]";
      operatorSelect.innerHTML = `<option value="" disabled selected>Operator</option>` +
        operatorOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('');

      const input = document.createElement('input');
      input.type = "text";
      input.placeholder = "Type value";
      input.className = "h-10 px-3 border border-gray-700 rounded-[8px] bg-gray-800 text-white w-[400px]";

      bottomRow.appendChild(fieldSelect);
      bottomRow.appendChild(operatorSelect);
      bottomRow.appendChild(input);

      wrapper.appendChild(bottomRow);
      container.appendChild(wrapper);
    }

    /* copy to  clipboard script starts here */
    function copySQL() {
      const sqlText = document.getElementById('sqlOutputFormated').textContent;
      copyToTheClipboard(sqlText);
    }

    async function copyToTheClipboard(textToCopy) {
      try {
        await navigator.clipboard.writeText(textToCopy);
        document.body.classList.add('show-copied');
        setTimeout(() => {
          document.body.classList.remove('show-copied');
        }, 3000);
      } catch (err) {
        console.error('Failed to copy: ', err);
      }
    }

    /* copy to  clipboard script ends here */

    /* add filter row script ends here */

    function removeFilterRow() {
      const container = document.getElementById('filterRows');
      if (container.children.length > 1) {
        container.lastElementChild.remove();
      }
    }

    //filter functionality ends here
    // Pre-select default metrics on page load
    ['Clicks', 'Impressions', 'CTR', 'Position'].forEach(metric => selectMetric(metric));
    // Inject the first filter row on page load
    addFilterRow();
  </script>

</body>

</html>